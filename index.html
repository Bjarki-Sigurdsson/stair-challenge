<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Stair Climb Challenge! üßó‚Äç‚ôÄÔ∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .podium-1 { border-color: #FFD700; } /* Gold */
        .podium-2 { border-color: #C0C0C0; } /* Silver */
        .podium-3 { border-color: #CD7F32; } /* Bronze */
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl md:text-5xl font-bold text-slate-900">Stair Climb Challenge!</h1>
            <p class="text-lg text-slate-600 mt-2">Who will reach the summit before the Christmas party? üéÑ</p>
            <button id="reset-btn" class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-red-600">Reset Competition</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Overall Leaderboard Section -->
            <section id="leaderboard-overall" class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-center">Overall Leaderboard</h2>
                <div id="leaderboard-list-overall" class="space-y-3">
                    <div class="text-center text-slate-500">Loading scores...</div>
                </div>
            </section>

            <!-- Weekly Leaderboard Section -->
            <section id="leaderboard-weekly" class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-center">This Week's Leaders</h2>
                <div id="leaderboard-list-weekly" class="space-y-3">
                    <div class="text-center text-slate-500">Loading scores...</div>
                </div>
            </section>
        </div>

        <!-- Participants Section -->
        <section id="participants" class="mt-8">
            <h2 class="text-2xl font-bold mb-4 text-center">Log Your Climb</h2>
            <div id="participant-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Participant cards will be injected here by JavaScript -->
            </div>
        </section>
        
        <!-- User ID display -->
        <div id="user-info" class="text-center mt-8 text-xs text-slate-400"></div>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // IMPORTANT: Firebase imports. Do not change these.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, runTransaction, setDoc, serverTimestamp, addDoc, query, orderBy, limit, getDocs, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ‚úèÔ∏è EDIT THIS SECTION ---
        // Add the names of all participants here.
        const participants = [
            "Annett", "Bjarki", "Lene", "Morten", "Lars"
        ];
        // --- END OF EDIT SECTION ---

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAuCviosEvMuvlq899_w_E2ldHD6v4epTI",
          authDomain: "stairclimbing-competition.firebaseapp.com",
          projectId: "stairclimbing-competition",
          storageBucket: "stairclimbing-competition.firebasestorage.app",
          messagingSenderId: "408087478849",
          appId: "1:408087478849:web:cc4430940e9ee7f6c43cc0",
          measurementId: "G-3SC0FMDNCE"
};

        // --- App Initialization ---
        let app, db, auth, userId;

        // --- Date Helper ---
        function getWeekId(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return d.getUTCFullYear() + '-' + weekNo;
        }

        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) { console.error("Firebase initialization failed:", e); return; }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-info').textContent = `Your User ID: ${userId}`;
                    setupRealtimeListener();
                } else {
                    try {
                        if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 
                        else { await signInAnonymously(auth); }
                    } catch (error) { console.error("Anonymous sign-in failed:", error); }
                }
            });
        }
        
        // --- UI Rendering ---
        const participantCardsContainer = document.getElementById('participant-cards');

        function createParticipantCards() {
            participantCardsContainer.innerHTML = '';
            participants.forEach(name => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-2xl shadow-md flex flex-col items-center justify-center transition-transform hover:scale-105';
                card.innerHTML = `
                    <div class="text-xl font-semibold">${name}</div>
                    <div class="text-4xl font-bold my-1 text-indigo-600" id="score-${name}">0</div>
                    <div class="text-xs text-slate-500 mb-2 space-x-2">
                        <span>Week: <b id="weekly-score-${name}">0</b></span>
                        <span>Today: <b id="daily-score-${name}">0</b></span>
                    </div>
                    <button data-name="${name}" class="add-climb-btn bg-indigo-600 text-white font-bold py-2 px-6 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors w-full">I Climbed!</button>
                    <button data-name="${name}" class="undo-climb-btn text-xs text-slate-400 hover:text-red-600 mt-2">Oops, undo last</button>
                `;
                participantCardsContainer.appendChild(card);
            });
        }
        
        function renderLeaderboard(containerId, scores, scoreType, subText) {
            const container = document.getElementById(containerId);
            const sortedScores = Object.values(scores).sort((a, b) => (b[scoreType] || 0) - (a[scoreType] || 0));
            container.innerHTML = '';

            if (sortedScores.filter(s => s[scoreType] > 0).length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500">No climbs logged yet.</div>`;
                return;
            }

            sortedScores.forEach((player, index) => {
                const rank = index + 1;
                let medal = '';
                let podiumClass = '';
                if (rank === 1) { medal = 'ü•á'; podiumClass = 'podium-1'; }
                else if (rank === 2) { medal = 'ü•à'; podiumClass = 'podium-2'; }
                else if (rank === 3) { medal = 'ü•â'; podiumClass = 'podium-3'; }

                const listItem = document.createElement('div');
                listItem.className = `flex items-center justify-between p-3 bg-slate-100 rounded-lg border-2 border-transparent ${podiumClass}`;
                const score = player[scoreType] || 0;
                const subValue = player[subText] ? (player[subText] || 0) : null;

                listItem.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-lg font-bold w-8">${rank}. ${medal}</span>
                        <span class="text-lg font-medium">${player.name}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-xl font-bold text-indigo-600">${score}</span>
                        ${subText ? `<span class="text-xs text-slate-500 block">(${subValue} today)</span>` : ''}
                    </div>
                `;
                if(score > 0) container.appendChild(listItem);
            });
        }

        function updateUI(scores) {
            participants.forEach(name => {
                const data = scores[name] || {};
                const totalEl = document.getElementById(`score-${name}`);
                const weeklyEl = document.getElementById(`weekly-score-${name}`);
                const dailyEl = document.getElementById(`daily-score-${name}`);
                if (totalEl) totalEl.textContent = data.totalClimbs || 0;
                if (weeklyEl) weeklyEl.textContent = data.weeklyClimbs || 0;
                if (dailyEl) dailyEl.textContent = data.dailyClimbs || 0;
            });
            renderLeaderboard('leaderboard-list-overall', scores, 'totalClimbs', 'dailyClimbs');
            renderLeaderboard('leaderboard-list-weekly', scores, 'weeklyClimbs', null);
        }

        // --- Realtime Data Handling ---
        function setupRealtimeListener() {
            const collectionPath = `/artifacts/${appId}/public/data/stairs_competition`;
            onSnapshot(collection(db, collectionPath), (snapshot) => {
                const scores = {};
                snapshot.docs.forEach(doc => { scores[doc.id] = doc.data(); });
                updateUI(scores);
            }, (error) => { console.error("Error fetching scores:", error); });
        }

        // --- Event Handling ---
        participantCardsContainer.addEventListener('click', async (e) => {
            const button = e.target;
            const name = button.dataset.name;
            if (!name) return;

            const collectionPath = `/artifacts/${appId}/public/data/stairs_competition`;
            const docRef = doc(db, collectionPath, name);
            
            if (button.classList.contains('add-climb-btn')) {
                button.disabled = true;
                button.textContent = 'Logging...';
                try {
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        const now = new Date();
                        const todayId = now.toISOString().slice(0, 10);
                        const weekId = getWeekId(now);
                        if (!sfDoc.exists()) {
                            transaction.set(docRef, { name, totalClimbs: 1, dailyClimbs: 1, weeklyClimbs: 1, lastResetDate: todayId, lastWeeklyResetId: weekId, lastUpdated: serverTimestamp() });
                        } else {
                            const data = sfDoc.data();
                            const newTotal = (data.totalClimbs || 0) + 1;
                            let newDaily = (data.dailyClimbs || 0) + 1;
                            let newWeekly = (data.weeklyClimbs || 0) + 1;
                            if (data.lastResetDate !== todayId) { newDaily = 1; }
                            if (data.lastWeeklyResetId !== weekId) { newWeekly = 1; }
                            transaction.update(docRef, { totalClimbs: newTotal, dailyClimbs: newDaily, weeklyClimbs: newWeekly, lastResetDate: todayId, lastWeeklyResetId: weekId, lastUpdated: serverTimestamp() });
                        }
                    });
                    const climbsLogRef = collection(db, docRef.path, 'climbsLog');
                    await addDoc(climbsLogRef, { timestamp: serverTimestamp(), climberId: userId });
                    const auditLogCollectionPath = `/artifacts/${appId}/public/data/stairs_competition_log`;
                    await addDoc(collection(db, auditLogCollectionPath), { participantName: name, timestamp: serverTimestamp(), date: new Date().toISOString().slice(0, 10), climberId: userId });
                } catch (error) { console.error("Add climb failed: ", error); } 
                finally { setTimeout(() => { button.disabled = false; button.textContent = 'I Climbed!'; }, 500); }
            }

            if (button.classList.contains('undo-climb-btn')) {
                button.disabled = true; button.textContent = 'Undoing...';
                try {
                    const climbsLogRef = collection(db, docRef.path, 'climbsLog');
                    const q = query(climbsLogRef, orderBy('timestamp', 'desc'), limit(1));
                    const querySnapshot = await getDocs(q);
                    if (querySnapshot.empty) { return; }
                    await deleteDoc(querySnapshot.docs[0].ref);
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        if (!sfDoc.exists()) return;
                        const data = sfDoc.data();
                        const now = new Date();
                        const todayId = now.toISOString().slice(0, 10);
                        const weekId = getWeekId(now);
                        const newTotal = Math.max(0, (data.totalClimbs || 0) - 1);
                        let newDaily = Math.max(0, (data.dailyClimbs || 0) - 1);
                        let newWeekly = Math.max(0, (data.weeklyClimbs || 0) - 1);
                        if (data.lastResetDate !== todayId) { newDaily = 0; }
                        if (data.lastWeeklyResetId !== weekId) { newWeekly = 0; }
                        transaction.update(docRef, { totalClimbs: newTotal, dailyClimbs: newDaily, weeklyClimbs: newWeekly, lastUpdated: serverTimestamp() });
                    });
                } catch (error) { console.error("Undo failed: ", error); } 
                finally { setTimeout(() => { button.disabled = false; button.textContent = 'Oops, undo last'; }, 500); }
            }
        });

        // --- NEW: Reset Logic ---
        document.getElementById('reset-btn').addEventListener('click', async () => {
            const password = prompt("To reset all scores and logs, please enter the admin password:");
            const RESET_PASSWORD = "reset2025"; // You can change this password

            if (password !== RESET_PASSWORD) {
                if(password !== null) alert("Incorrect password.");
                return;
            }

            if (!confirm("Are you absolutely sure you want to delete ALL data for this competition? This cannot be undone.")) {
                return;
            }

            const resetButton = document.getElementById('reset-btn');
            resetButton.disabled = true;
            resetButton.textContent = "Resetting...";

            try {
                // Delete main scores
                const scoresPath = `/artifacts/${appId}/public/data/stairs_competition`;
                const scoresSnapshot = await getDocs(collection(db, scoresPath));
                const batch1 = writeBatch(db);
                scoresSnapshot.forEach(doc => batch1.delete(doc.ref));
                await batch1.commit();

                // Delete audit log
                const auditLogPath = `/artifacts/${appId}/public/data/stairs_competition_log`;
                const auditLogSnapshot = await getDocs(collection(db, auditLogPath));
                const batch2 = writeBatch(db);
                auditLogSnapshot.forEach(doc => batch2.delete(doc.ref));
                await batch2.commit();
                
                // Note: The individual undo logs (subcollections) will remain but are now orphaned.
                // This is generally fine and avoids much more complex recursive deletion logic.

                alert("Competition has been successfully reset.");

            } catch (error) {
                console.error("Reset failed:", error);
                alert("An error occurred during the reset process. Check the console for details.");
            } finally {
                resetButton.disabled = false;
                resetButton.textContent = "Reset Competition";
            }
        });

        // --- App Start ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            createParticipantCards();
        });
    </script>
</body>
</html>


